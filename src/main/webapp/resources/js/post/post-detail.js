// Ï†ÑÏó≠ Î≥ÄÏàò
let isLiked = false;
let isBookmarked = false;
let commentCharCount = 0;

// DOM Î°úÎìú ÏôÑÎ£å Ïãú Ï¥àÍ∏∞Ìôî
document.addEventListener('DOMContentLoaded', function() {
  initializePostDetail();
  setupEventListeners();
  setupScrollEvents();
  initializeComments();
});

// Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
function initializePostDetail() {
  // ÏΩîÎìú Î∏îÎ°ù ÌïòÏù¥ÎùºÏù¥ÌåÖ
  highlightCodeBlocks();

  // Ïô∏Î∂Ä ÎßÅÌÅ¨ ÏÉà Ï∞ΩÏóêÏÑú Ïó¥Í∏∞
  setupExternalLinks();

  // Ïù¥ÎØ∏ÏßÄ ÏßÄÏó∞ Î°úÎî©
  setupLazyLoading();

  // Î∞òÏùë ÏÉÅÌÉú Î≥µÏõê
  restoreReactionStates();

  // ÌéòÏù¥ÏßÄ Ïï†ÎãàÎ©îÏù¥ÏÖò
  animatePageLoad();
}

// Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
function setupEventListeners() {
  // ÎåìÍ∏Ä ÏûÖÎ†• ÌïÑÎìú Ïù¥Î≤§Ìä∏
  const commentTextarea = document.querySelector('.comment-textarea');
  if (commentTextarea) {
    commentTextarea.addEventListener('input', updateCommentCharCount);
    commentTextarea.addEventListener('keydown', handleCommentKeydown);
  }

  // Î∞òÏùë Î≤ÑÌäº Ïù¥Î≤§Ìä∏
  setupReactionButtons();

  // ÏÇ≠Ï†ú Î≤ÑÌäº Ïù¥Î≤§Ìä∏
  const deleteBtn = document.querySelector('.delete-btn');
  if (deleteBtn) {
    deleteBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const postId = getPostIdFromUrl();
      confirmDeletePost(postId);
    });
  }

  // ÎåìÍ∏Ä Ìèº Ïù¥Î≤§Ìä∏
  const commentForm = document.querySelector('.comment-form');
  if (commentForm) {
    commentForm.addEventListener('submit', submitComment);
  }
}

// Ïä§ÌÅ¨Î°§ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
function setupScrollEvents() {
  let ticking = false;

  window.addEventListener('scroll', function() {
    if (!ticking) {
      requestAnimationFrame(function() {
        updateScrollElements();
        ticking = false;
      });
      ticking = true;
    }
  });
}

// ÎåìÍ∏Ä ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
function initializeComments() {
  updateCommentCharCount();
}

// Î∞òÏùë Î≤ÑÌäº ÏÑ§Ï†ï
function setupReactionButtons() {
  const likeBtn = document.querySelector('.like-btn');
  const bookmarkBtn = document.querySelector('.bookmark-btn');
  const shareBtn = document.querySelector('.share-btn');

  if (likeBtn) {
    likeBtn.addEventListener('click', function() {
      const postId = getPostIdFromUrl();
      toggleLike(postId);
    });
  }

  if (bookmarkBtn) {
    bookmarkBtn.addEventListener('click', function() {
      const postId = getPostIdFromUrl();
      toggleBookmark(postId);
    });
  }

  if (shareBtn) {
    shareBtn.addEventListener('click', function() {
      const postId = getPostIdFromUrl();
      sharePost(postId);
    });
  }
}

// URLÏóêÏÑú Í≤åÏãúÍ∏Ä ID Ï∂îÏ∂ú
function getPostIdFromUrl() {
  const path = window.location.pathname;
  const matches = path.match(/\/posts\/(\d+)/);
  return matches ? parseInt(matches[1]) : null;
}

// Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏
function isLoggedIn() {
  return document.querySelector('.nav-user-info') !== null ||
      document.querySelector('.comment-form-container') !== null;
}

// ÎåìÍ∏Ä Í∏ÄÏûê Ïàò ÏóÖÎç∞Ïù¥Ìä∏
function updateCommentCharCount() {
  const textarea = document.querySelector('.comment-textarea');
  const charCount = document.querySelector('.char-count');

  if (textarea && charCount) {
    const count = textarea.value.length;
    commentCharCount = count;
    charCount.textContent = `${count}/500`;

    // Í∏ÄÏûê ÏàòÏóê Îî∞Î•∏ ÏÉâÏÉÅ Î≥ÄÍ≤Ω
    if (count > 450) {
      charCount.style.color = '#ff3b30';
    } else if (count > 400) {
      charCount.style.color = '#ffcc00';
    } else {
      charCount.style.color = '#86868b';
    }
  }
}

// ÎåìÍ∏Ä ÏûÖÎ†• ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏
function handleCommentKeydown(event) {
  // Ctrl+Enter ÎòêÎäî Cmd+EnterÎ°ú ÎåìÍ∏Ä Ï†úÏ∂ú
  if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
    event.preventDefault();
    const form = event.target.closest('.comment-form');
    if (form) {
      submitComment({ target: form, preventDefault: () => {} });
    }
  }
}

// Ïä§ÌÅ¨Î°§ Í¥ÄÎ†® ÏöîÏÜå ÏóÖÎç∞Ïù¥Ìä∏
function updateScrollElements() {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const scrollToTopBtn = document.querySelector('.scroll-to-top');

  if (scrollToTopBtn) {
    if (scrollTop > 300) {
      scrollToTopBtn.style.opacity = '1';
      scrollToTopBtn.style.pointerEvents = 'auto';
    } else {
      scrollToTopBtn.style.opacity = '0.6';
      scrollToTopBtn.style.pointerEvents = 'auto';
    }
  }
}

// ÏΩîÎìú Î∏îÎ°ù ÌïòÏù¥ÎùºÏù¥ÌåÖ
function highlightCodeBlocks() {
  const codeBlocks = document.querySelectorAll('pre code');
  codeBlocks.forEach(block => {
    block.classList.add('highlighted');
  });
}

// Ïô∏Î∂Ä ÎßÅÌÅ¨ ÏÑ§Ï†ï
function setupExternalLinks() {
  const links = document.querySelectorAll('.content-body a[href^="http"]');
  links.forEach(link => {
    if (!link.hostname.includes(window.location.hostname)) {
      link.setAttribute('target', '_blank');
      link.setAttribute('rel', 'noopener noreferrer');
      link.setAttribute('title', 'Ïô∏Î∂Ä ÎßÅÌÅ¨');
    }
  });
}

// Ïù¥ÎØ∏ÏßÄ ÏßÄÏó∞ Î°úÎî© ÏÑ§Ï†ï
function setupLazyLoading() {
  const images = document.querySelectorAll('.content-body img[data-src]');

  if ('IntersectionObserver' in window && images.length > 0) {
    const imageObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.classList.remove('lazy');
            imageObserver.unobserve(img);
          }
        }
      });
    });

    images.forEach(img => {
      imageObserver.observe(img);
    });
  }
}

// Î∞òÏùë ÏÉÅÌÉú Î≥µÏõê
function restoreReactionStates() {
  const postId = getPostIdFromUrl();
  if (postId && isLoggedIn()) {
    // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî ÏÑúÎ≤Ñ API Ìò∏Ï∂úÎ°ú ÏÇ¨Ïö©ÏûêÏùò Î∞òÏùë ÏÉÅÌÉú Î≥µÏõê
    // fetch(`/api/posts/${postId}/reactions`)
    //   .then(response => response.json())
    //   .then(data => {
    //     if (data.liked) toggleLikeUI(true);
    //     if (data.bookmarked) toggleBookmarkUI(true);
    //   });
  }
}

// ÌéòÏù¥ÏßÄ Î°úÎìú Ïï†ÎãàÎ©îÏù¥ÏÖò
function animatePageLoad() {
  const postDetail = document.querySelector('.post-detail');
  const commentsSection = document.querySelector('.comments-section');

  if (postDetail) {
    postDetail.style.opacity = '0';
    postDetail.style.transform = 'translateY(20px)';

    setTimeout(() => {
      postDetail.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
      postDetail.style.opacity = '1';
      postDetail.style.transform = 'translateY(0)';
    }, 100);
  }

  if (commentsSection) {
    commentsSection.style.opacity = '0';
    commentsSection.style.transform = 'translateY(20px)';

    setTimeout(() => {
      commentsSection.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
      commentsSection.style.opacity = '1';
      commentsSection.style.transform = 'translateY(0)';
    }, 300);
  }
}

// Ï¢ãÏïÑÏöî ÌÜ†Í∏Ä
function toggleLike(postId) {
  if (!postId) return;

  if (!isLoggedIn()) {
    showNotification('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú Í∏∞Îä•ÏûÖÎãàÎã§.', 'warning');
    return;
  }

  const likeBtn = document.querySelector('.like-btn');
  if (!likeBtn) return;

  const icon = likeBtn.querySelector('.reaction-icon');

  // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
  if (isLiked) {
    icon.textContent = 'ü§ç';
    likeBtn.classList.remove('active');
    isLiked = false;
    showNotification('Ï¢ãÏïÑÏöîÎ•º Ï∑®ÏÜåÌñàÏäµÎãàÎã§.', 'info');
  } else {
    icon.textContent = '‚ù§Ô∏è';
    likeBtn.classList.add('active');
    isLiked = true;
    showNotification('Ï¢ãÏïÑÏöîÎ•º ÎàåÎ†ÄÏäµÎãàÎã§!', 'success');
  }

  // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑú ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠
  /*
  fetch(`/api/posts/${postId}/like`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      // Ïã§Ìå® Ïãú ÏõêÎûò ÏÉÅÌÉúÎ°ú Î≥µÏõê
      toggleLike(postId);
      showNotification('Ï¢ãÏïÑÏöî Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
  });
  */
}

// Î∂ÅÎßàÌÅ¨ ÌÜ†Í∏Ä
function toggleBookmark(postId) {
  if (!postId) return;

  if (!isLoggedIn()) {
    showNotification('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú Í∏∞Îä•ÏûÖÎãàÎã§.', 'warning');
    return;
  }

  const bookmarkBtn = document.querySelector('.bookmark-btn');
  if (!bookmarkBtn) return;

  const icon = bookmarkBtn.querySelector('.reaction-icon');

  // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
  if (isBookmarked) {
    icon.textContent = 'üìñ';
    bookmarkBtn.classList.remove('active');
    isBookmarked = false;
    showNotification('Î∂ÅÎßàÌÅ¨Í∞Ä Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§.', 'info');
  } else {
    icon.textContent = 'üìó';
    bookmarkBtn.classList.add('active');
    isBookmarked = true;
    showNotification('Î∂ÅÎßàÌÅ¨Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.', 'success');
  }
}

// Í≤åÏãúÍ∏Ä Í≥µÏú†
function sharePost(postId) {
  const url = window.location.href;
  const title = document.querySelector('.post-title')?.textContent || 'Í≤åÏãúÍ∏Ä';

  if (navigator.share) {
    // Web Share API ÏÇ¨Ïö© (Î™®Î∞îÏùº)
    navigator.share({
      title: title,
      url: url
    }).then(() => {
      showNotification('Í≥µÏú†ÎêòÏóàÏäµÎãàÎã§!', 'success');
    }).catch(err => {
      if (err.name !== 'AbortError') {
        copyToClipboard(url);
      }
    });
  } else {
    // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
    copyToClipboard(url);
  }
}

// ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      showNotification('ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
    }).catch(err => {
      fallbackCopyToClipboard(text);
    });
  } else {
    fallbackCopyToClipboard(text);
  }
}

// ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ìè¥Î∞±
function fallbackCopyToClipboard(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.left = '-999999px';
  textArea.style.top = '-999999px';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    document.execCommand('copy');
    showNotification('ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
  } catch (err) {
    showNotification('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú Î≥µÏÇ¨Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
  }

  document.body.removeChild(textArea);
}

// Í≤åÏãúÍ∏Ä ÏÇ≠Ï†ú ÌôïÏù∏
function confirmDeletePost(postId) {
  if (!postId) return;

  const confirmed = confirm('Ï†ïÎßêÎ°ú Ïù¥ Í≤åÏãúÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏÇ≠Ï†úÎêú Í≤åÏãúÍ∏ÄÏùÄ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');

  if (confirmed) {
    deletePost(postId);
  }
}

// Í≤åÏãúÍ∏Ä ÏÇ≠Ï†ú
function deletePost(postId) {
  showNotification('Í≤åÏãúÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÎäî Ï§ë...', 'info');

  // Ïã§Ï†ú ÏÇ≠Ï†ú Ìèº Ï†úÏ∂ú
  const deleteForm = document.querySelector('#deleteForm');
  if (deleteForm) {
    deleteForm.submit();
  } else {
    // ÌèºÏù¥ ÏóÜÎã§Î©¥ ÏßÅÏ†ë POST ÏöîÏ≤≠
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/posts/${postId}/delete`;
    form.style.display = 'none';
    document.body.appendChild(form);
    form.submit();
  }
}

// ÎåìÍ∏Ä Ï†úÏ∂ú
function submitComment(event) {
  event.preventDefault();

  const form = event.target;
  const textarea = form.querySelector('.comment-textarea');
  const isSecret = form.querySelector('input[name="isSecret"]')?.checked || false;
  const content = textarea.value.trim();

  if (!content) {
    showNotification('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
    textarea.focus();
    return;
  }

  if (content.length < 2) {
    showNotification('ÎåìÍ∏ÄÏùÄ 2Ïûê Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
    textarea.focus();
    return;
  }

  if (!isLoggedIn()) {
    showNotification('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú Í∏∞Îä•ÏûÖÎãàÎã§.', 'warning');
    return;
  }

  // Ï†úÏ∂ú Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = 'ÏûëÏÑ± Ï§ë...';

  // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî ÏÑúÎ≤ÑÏóê ÎåìÍ∏Ä Ï†ÑÏÜ°
  setTimeout(() => {
    showNotification('ÎåìÍ∏ÄÏù¥ ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§!', 'success');
    resetCommentForm();

    // Ï†úÏ∂ú Î≤ÑÌäº Î≥µÏõê
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;

    // ÎåìÍ∏Ä Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
    updateCommentCount();
  }, 1000);
}

// ÎåìÍ∏Ä Ìèº Ï¥àÍ∏∞Ìôî
function resetCommentForm() {
  const textarea = document.querySelector('.comment-textarea');
  const isSecretCheckbox = document.querySelector('input[name="isSecret"]');
  const charCount = document.querySelector('.char-count');

  if (textarea) {
    textarea.value = '';
  }
  if (isSecretCheckbox) {
    isSecretCheckbox.checked = false;
  }
  if (charCount) {
    charCount.textContent = '0/500';
    charCount.style.color = '#86868b';
  }

  commentCharCount = 0;
}

// ÎåìÍ∏Ä Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
function updateCommentCount() {
  const commentCountElement = document.querySelector('.comment-count');
  const statNumberElement = document.querySelector('.stat-item .stat-number');

  if (commentCountElement) {
    let currentCount = parseInt(commentCountElement.textContent) || 0;
    commentCountElement.textContent = currentCount + 1;
  }

  if (statNumberElement && statNumberElement.parentElement.querySelector('.stat-icon')?.textContent === 'üí¨') {
    let currentCount = parseInt(statNumberElement.textContent) || 0;
    statNumberElement.textContent = currentCount + 1;
  }
}

// ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ
function formatDate(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diff = now - date;

  // 1Î∂Ñ ÎØ∏Îßå
  if (diff < 60000) {
    return 'Î∞©Í∏à Ï†Ñ';
  }
  // 1ÏãúÍ∞Ñ ÎØ∏Îßå
  if (diff < 3600000) {
    return `${Math.floor(diff / 60000)}Î∂Ñ Ï†Ñ`;
  }
  // 24ÏãúÍ∞Ñ ÎØ∏Îßå
  if (diff < 86400000) {
    return `${Math.floor(diff / 3600000)}ÏãúÍ∞Ñ Ï†Ñ`;
  }
  // Í∑∏ Ïô∏
  return date.toLocaleDateString('ko-KR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

// Îß® ÏúÑÎ°ú Ïä§ÌÅ¨Î°§
function scrollToTop() {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
}

// ÎåìÍ∏ÄÎ°ú Ïä§ÌÅ¨Î°§
function scrollToComments() {
  const commentsSection = document.querySelector('.comments-section');
  if (commentsSection) {
    commentsSection.scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });
  }
}

// ÏïåÎ¶º ÌëúÏãú
function showNotification(message, type = 'info') {
  // Í∏∞Ï°¥ ÏïåÎ¶º Ï†úÍ±∞
  const existingNotification = document.querySelector('.notification');
  if (existingNotification) {
    existingNotification.remove();
  }

  // ÏÉà ÏïåÎ¶º ÏÉùÏÑ±
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.textContent = message;

  document.body.appendChild(notification);

  // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 3000);
}